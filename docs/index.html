<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gold Pixel — MVP Online</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    :root { --bg:#0b0f14; --panel:#121926; --text:#e7eef8; --muted:#9fb0c5; --stroke:#223047; }
    body { margin:0; font-family: sans-serif; background: var(--bg); color: var(--text); display:flex; height:100vh; overflow: hidden; }
    
    /* Menu de gauche (Le Blindage) */
    .left { width: 300px; padding:20px; border-right:1px solid var(--stroke); background: var(--panel); z-index: 10; }
    .card { border:1px solid var(--stroke); background: rgba(255,255,255,0.03); border-radius:12px; padding:15px; margin-bottom:15px; }
    
    /* Boutons et Couleurs */
    .btn { background: #2f6fed; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 5px; }
    .swatches { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .swatch { width:30px; height:30px; border-radius:5px; cursor:pointer; border: 2px solid transparent; }
    .swatch.active { border-color: white; }
    
    /* Zone de jeu */
    .main { flex:1; position:relative; cursor: crosshair; }
    canvas { display:block; width:100%; height:100%; }
    .coords { position:absolute; right:20px; bottom:20px; background: rgba(0,0,0,0.7); padding:10px; border-radius:8px; }
  </style>
</head>
<body>

  <aside class="left">
    <h2>Gold Pixel</h2>
    <p style="font-size: 12px; color: var(--muted);">Projet : JeuxVideo.Pi</p>
    
    <div class="card">
      <strong>Pack choisi</strong>
      <button class="btn" id="btnPack">Pack Essentiel (60s)</button>
    </div>

    <div class="card">
      <strong>Choisir une couleur</strong>
      <div id="palette" class="swatches"></div>
    </div>

    <div class="card">
      <div id="status" style="color: #ffaa00;">Connexion au serveur...</div>
    </div>
  </aside>

  <main class="main">
    <canvas id="grille"></canvas>
    <div class="coords" id="coords">x: 0 • y: 0</div>
  </main>

<script>
  // CONFIGURATION SIMPLE
  // C'est ici que le "Garde" se connecte à la "Forteresse"
  const socket = io("http://localhost:3000"); 
  const canvas = document.getElementById("grille");
  const ctx = canvas.getContext("2d");
  const GRID_SIZE = 512;
  let selectedColor = "#FF0000";

  // Création d'une image invisible pour stocker les pixels (La Forteresse)
  const memoireGrille = document.createElement('canvas');
  memoireGrille.width = GRID_SIZE;
  memoireGrille.height = GRID_SIZE;
  const mCtx = memoireGrille.getContext('2d');
  mCtx.fillStyle = "#121926"; // Fond par défaut
  mCtx.fillRect(0,0,GRID_SIZE,GRID_SIZE);

  // Couleurs disponibles
  const couleurs = ["#FFFFFF", "#000000", "#FF0000", "#00FF00", "#0000FF", "#FFFF00", "#FFA500", "#FF00FF"];
  
  // 1. Dessiner la palette
  const paletteDiv = document.getElementById("palette");
  couleurs.forEach(color => {
    const div = document.createElement("div");
    div.className = "swatch";
    div.style.background = color;
    if(color === selectedColor) div.classList.add("active");
    div.onclick = () => {
      selectedColor = color;
      document.querySelectorAll(".swatch").forEach(s => s.classList.remove("active"));
      div.classList.add("active");
    };
    paletteDiv.appendChild(div);
  });

  // 2. Recevoir les données du serveur (La Sentinelle)
  socket.on('connect', () => {
    document.getElementById("status").textContent = "✅ Connecté au serveur";
    document.getElementById("status").style.color = "#00FF00";
  });

  socket.on('init_canvas', (data) => {
    // Le serveur nous envoie toute la grille d'un coup
    for(let i=0; i < GRID_SIZE * GRID_SIZE; i++) {
      const x = i % GRID_SIZE;
      const y = Math.floor(i / GRID_SIZE);
      mCtx.fillStyle = `rgb(${data[i*3]}, ${data[i*3+1]}, ${data[i*3+2]})`;
      mCtx.fillRect(x, y, 1, 1);
    }
  });

  socket.on('pixel_update', ({x, y, color}) => {
    // Quand quelqu'un d'autre pose un pixel
    mCtx.fillStyle = `rgb(${color[0]}, ${color[1]}, ${color[2]})`;
    mCtx.fillRect(x, y, 1, 1);
  });

  // 3. Dessiner la grille à l'écran
  function dessiner() {
    canvas.width = canvas.clientWidth;
    canvas.height = canvas.clientHeight;
    
    // On efface tout et on redessine l'image stockée en mémoire
    ctx.imageSmoothingEnabled = false; 
    ctx.drawImage(memoireGrille, 0, 0, canvas.width, canvas.height);
    
    requestAnimationFrame(dessiner);
  }

  // 4. Cliquer pour poser un pixel
  canvas.addEventListener("click", (e) => {
    const rect = canvas.getBoundingClientRect();
    // On calcule où on a cliqué par rapport à la grille de 512x512
    const x = Math.floor((e.clientX - rect.left) / (canvas.width / GRID_SIZE));
    const y = Math.floor((e.clientY - rect.top) / (canvas.height / GRID_SIZE));

    // On transforme l'hexadécimal (#FF0000) en RGB (255, 0, 0)
    const r = parseInt(selectedColor.slice(1,3), 16);
    const g = parseInt(selectedColor.slice(3,5), 16);
    const b = parseInt(selectedColor.slice(5,7), 16);

    // On envoie l'ordre à la Forteresse (le serveur)
    socket.emit('claim_pixel', { x, y, color: [r, g, b] });
  });

  dessiner();
})();
</script>
</body>
</html>
